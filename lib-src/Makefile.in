# Makefile.in -- input for the lib-src directory's Makefile
# Copyright (C) 1998 John Harper <john@dcs.warwick.ac.uk>
# $Id$
#
# This file is part of Jade.
#
# Jade is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2, or (at your option)
# any later version.
#
# Jade is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Jade; see the file COPYING.  If not, write to
# the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.

include ../Makedefs

top_srcdir=@top_srcdir@
srcdir=@srcdir@
VPATH=@top_srcdir@/lib-src:@top_srcdir@/src:@top_srcdir@/malloc-src:.

DYN_SRCS = server-dl.c
DYN_OBJS = $(DYN_SRCS:.c=.$(dynsuffix))

JADE_SRCS = $(wildcard $(srcdir)/../src/*.c)

INSTALL_FILES = $(addprefix @top_srcdir@/lib-src/, jademail)


all_targets := doc-strings.h jade_protos.h build.h $(DYN_OBJS) jadeclient
ifeq ($(HAVE_GNU_MALLOC),0)
 all_targets := $(all_targets) gnu-malloc
endif

all : $(all_targets)


## Various meta-files

jade_protos.h : stripproto $(JADE_SRCS)
	./stripproto -o $@ $(patsubst stripproto,,$^)

doc-strings.h ../DOC : makedoc $(JADE_SRCS) $(DYN_SRCS)
	./makedoc ../DOC doc-strings.h $(patsubst makedoc,,$^)

build.h : build-info
	$< $(host_type)


## GNU malloc targets, borrowed from malloc-src/Makefile

gnu-malloc : libmalloc.a gmalloc.o

gnu-gmalloc     := valloc.c malloc.c free.c cfree.c realloc.c calloc.c \
		   morecore.c memalign.c
gnu-malloc-srcs := valloc.c malloc.c free.c cfree.c realloc.c calloc.c \
		   morecore.c memalign.c mcheck.c mtrace.c mstats.c ralloc.c \
		   malloc-find.c
gnu-malloc-objs := $(gnu-malloc-srcs:.c=.o)
gnu-malloc-hdrs := malloc.h

libmalloc.a : valloc.o malloc.o free.o 

libmalloc.a : $(gnu-malloc-objs)
	ar crv $@ $(gnu-malloc-objs)
	ranlib $@

$(gnu-malloc-objs) : $(gnu-malloc-hdrs)

gmalloc.c: gmalloc-head.c $(gnu-malloc-hdrs) $(gnu-gmalloc)
	cat $^ > $@-tmp
	mv -f $@-tmp $@
	chmod a-w $@


## Other targets

install : all installdirs
	$(INSTALL_PROGRAM) jadeclient $(bindir)
	$(INSTALL_PROGRAM) $(DYN_OBJS) $(jadeexecdir)
	$(INSTALL_PROGRAM) $(INSTALL_FILES) $(jadeexecdir)

installdirs : $(top_srcdir)/mkinstalldirs
	$(SHELL) $(top_srcdir)/mkinstalldirs $(bindir) $(jadeexecdir)

uninstall : all
	rm -f $(bindir)/jadeclient
	rm -rf $(jadeexecdir)

clean :
	rm -f *~ *.o jade_protos.h doc-strings.h ../DOC build.h core
	rm -f $(gnu-malloc-objs) libmalloc.a gmalloc.o

realclean : clean
	rm -f .*.d makedoc stripproto Makefile
	rm -f gmalloc.c

$(DYN_OBJS) : %.$(dynsuffix) : %.c

include $(DYN_SRCS:%.c=.%.d .jadeclient.d)
