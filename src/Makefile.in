# Makefile.in -- input for the src directory's Makefile
# Copyright (C) 1998 John Harper <john@dcs.warwick.ac.uk>
# $Id$
#
# This file is part of Jade.
#
# Jade is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2, or (at your option)
# any later version.
#
# Jade is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Jade; see the file COPYING.  If not, write to
# the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.

include ../Makedefs

top_srcdir=@top_srcdir@
srcdir=@srcdir@
VPATH=@top_srcdir@/src:@top_srcdir@/lib-src:../lib:.

# Check if we're building a dumped binary
ifeq ($(notdir $(shell pwd)), jaded)
  DUMPED_JADE = 1
else
  DUMPED_JADE = 0
endif

COMMON_SRCS =	buffers.c commands.c debug-buffer.c edit.c editcommands.c \
		extent.c faces.c files.c find.c glyphs.c housekeeping.c \
		keys.c lisp.c lispcmds.c lispmach.c main.c misc.c movement.c \
		redisplay.c regexp.c regjade.c regsub.c streams.c stringmem.c \
		symbols.c undo.c values.c views.c windows.c
COMMON_HDRS =	jade.h edit.h lisp.h value.h keys.h stringmem.h \
		revision.h regexp.h

X11_SRCS =	x11_keys.c x11_main.c x11_misc.c x11_windows.c
X11_HDRS =	x11_defs.h x11_windowsys.h

UNIX_SRCS =	lists.c unix_dl.c unix_files.c unix_main.c unix_processes.c
UNIX_HDRS =	unix_defs.h

SRCS = $(COMMON_SRCS)
HDRS = $(COMMON_HDRS)

ifneq ($(HAVE_X11), 0)
 SRCS += $(X11_SRCS)
 HDRS += $(X11_HDRS)
endif

ifneq ($(HAVE_UNIX), 0)
 SRCS += $(UNIX_SRCS)
 HDRS += $(UNIX_HDRS)
endif

OBJS = $(SRCS:.c=.o)

ifeq ($(DUMPED_JADE), 1)
 CFLAGS := $(CFLAGS) -DDUMPED
 DUMP_FLAGS := @dump_flags@
 DUMPED_IN  := $(dumped_lisp_files)
 DUMPED_SRC := $(addprefix ../lisp/, $(addsuffix .jl, $(DUMPED_IN)))
 DUMPED_CMP := $(DUMPED_SRC:.jl=.jlc)
 DUMPED_ASM := dumped.s
 DUMPED_OBJ := $(DUMPED_ASM:.s=.o)
 OBJS       += $(DUMPED_OBJ)
endif

ifneq ($(HAVE_X11), 0)
 LIBS += $(X11LIBS)
endif

ifeq ($(HAVE_GNU_MALLOC),0)
 LIBS := ../lib/gmalloc.o $(LIBS) ../lib/libmalloc.a
endif

ifeq ($(DUMPED_JADE), 0)
 all : jade
else
 all : jaded
endif

jade : jade_protos.h doc-strings.h $(OBJS) $(LIBOBJS)
	$(CC) $(LDFLAGS) $(DL_LDFLAGS) -o jade $(OBJS) $(LIBOBJS) $(LIBS)

jaded : jade_protos.h doc-strings.h $(OBJS) $(LIBOBJS)
	$(CC) $(LDFLAGS) $(DL_LDFLAGS) -o jaded $(OBJS) $(LIBOBJS) $(LIBS)

ifeq ($(DUMPED_JADE), 1)
$(DUMPED_ASM) : $(DUMPED_CMP)
	JADELISPLIB=../lisp ../jade/jade -batch \
	  -l dump -f dump-batch $(DUMP_FLAGS) -o $@ $(dumped_lisp_files)

$(DUMPED_CMP) : $(DUMPED_SRC)
	(cd $(top_srcdir)/lisp && $(MAKE) lisp)
endif

clean :
	rm -f *~ *.o build.h core

realclean : clean
	rm -f .*.d jade jaded jadeclient makedoc stripproto Makefile
	rm -f dump.out dumped.s

include $(SRCS:%.c=.%.d)
